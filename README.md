# Bloc Demo

This project uses the bloc pattern to save the application state.

It demonstrates logging in/out and loading a list of posts.

A video of the app running can be found [here](https://youtu.be/Xk5b-5eMol0).

This is a modified version of the TODO TODO

If you interested in comparison between Redux and Bloc, have a look the the [flutter_posts_redux](https://github.com/billylev/flutter_posts_redux) project, that implements this exact same app using the Redux pattern.

# Getting Started

## [json_serializable](https://pub.dartlang.org/packages/json_serializable)

The json_serializable package is used. This generates the xxxx.g.dart files from the coresponding xxxx.dart models to enable json serialization.

Open a command prompt and run

```
$ flutter packages pub run build_runner watch
```

# Overview

The idea behind the Bloc pattern is to seperate out the Business Logic from the UI.

This makes the business logic reusable and easier to test.

Bloc pattern makes heavy use of reactive programming.

### Top Level

At the top level code is divided into the follow folders to separate out the responsibilities.

```
+-- lib
    +-- api
    +-- bloc_helpers
    +-- blocs
    +-- models
    +-- ui
```

* api folder holds the classes to call our http api
* bloc_helpers holds the reuseable bloc pattern code.
* blocs folder holds the blocs
* model folder holds our models
* ui folder holds our ui code

### Bloc Helpers

Credit for bloc helpers goes to [Didier Boelens](https://www.didierboelens.com). Please visit his site for in depth articles on Bloc Pattern.

### Models

```
+-- lib
    +-- model
      +-- posts.dart
      +-- sessions.dart
```

(Note in the model folder you will see .g.dart files, these files are generated by the build_value package for us.)

In Session.dart we just define the 3 parameters we interested in from the login response.

In Posts.dart have to define 2 classes, one to hold the list of posts, and one to define the post contents itself.

### Blocs

For each part of the app, a bloc is defined. A bloc holds a the bloc, the events, the state.

The bloc holds the data that will displayed, any business logic, and a eventHandler.

The events define events that can be triggered that may change the bloc state.

The states define states that UI responds to.

```
+-- lib
    +-- blocs
      +-- login
      +-- posts
      +-- session
```

* login folder holds the login blocs/events/states
* posts folder holds the posts blocs/events/states
* session folder holds the session blocs/events/states

### Session

This session bloc is used to decide which screen to display at the apps route.

There 3 events that when processed trigger 3 states.

* SessionStarted
* SessionLogin
* SessionLogout

* Uninitialized => show SplashScreen
* Unauthenticated => show LoginScreen
* Authenticated => show Dashboard

When the app begins its in an Uninitialized state. SessionStarted is triggered, which checks if the user has a login token.

Depending on the result, it will change the state to Authenticated or Unauthenticated.

### Login

To login, we need to get the username & password, call an api to authenticate the user, show a busy status whilst that happens, then if successful allow the user into the app, if unsuccessful show an error message.

There is 1 event, and 3 states.

* LoginRequest

* LoginForm => show the login screen
* LoginLoading => show the loading spinner
* LoginFailure => show login screen with an error

When the user presses the login button, the LoginRequest is sent.

When LoginRequest gets processed it sets the state to LoginLoading, calls the authentication api, then sets the state to LoginForm or LoginFailure.
If it authenticated ok, it also sends out a SessionLogin event which causes the state to change to Authenticated.

### Posts

Posts

Posts get displayed in a list, if pulled the list gets refreshed.

There is 1 event, and 4 states.

* LoadPostsRequest

* PostsEmpty
* PostsLoading
* PostsLoaded
* PostsFailure

After a successful login, the LoadPostsRequest event gets sent.

When LoadPostsRequest gets process the state changes to PostsLoading, the api called and depending on the result the state changes to PostsEmpty, PostsFailure, or PostsLoaded.

Posts also defines a stream. This stream gets filled with the actual posts. Whenever the stream changes the UI updates the list.

```
  BehaviorSubject<Posts> _itemsController = BehaviorSubject<Posts>();
  Stream<Posts> get items => _itemsController;
```
